var clippy={};clippy.Agent=function(n,t,i){this.path=n;this._queue=new clippy.Queue($.proxy(this._onQueueEmpty,this));this._el=$('<div class="clippy"><\/div>').hide();$(document.body).append(this._el);this._animator=new clippy.Animator(this._el,n,t,i);this._balloon=new clippy.Balloon(this._el);this._setupEvents()};clippy.Agent.prototype={gestureAt:function(n,t){var i=this._getDirection(n,t),r="Gesture"+i,u="Look"+i,f=this.hasAnimation(r)?r:u;return this.play(f)},hide:function(n,t){this._hidden=!0;var i=this._el;if(this.stop(),n){this._el.hide();this.stop();this.pause();t&&t();return}return this._playInternal("Hide",function(){i.hide();this.pause();t&&t()})},moveTo:function(n,t,i){var u=this._getDirection(n,t),r="Move"+u;i===undefined&&(i=1e3);this._addToQueue(function(u){if(i===0){this._el.css({top:t,left:n});this.reposition();u();return}if(!this.hasAnimation(r)){this._el.animate({top:t,left:n},i,u);return}var f=$.proxy(function(r,f){f===clippy.Animator.States.EXITED&&u();f===clippy.Animator.States.WAITING&&this._el.animate({top:t,left:n},i,$.proxy(function(){this._animator.exitAnimation()},this))},this);this._playInternal(r,f)},this)},_playInternal:function(n,t){this._isIdleAnimation()&&this._idleDfd&&this._idleDfd.state()==="pending"&&this._idleDfd.done($.proxy(function(){this._playInternal(n,t)},this));this._animator.showAnimation(n,t)},play:function(n,t,i){return this.hasAnimation(n)?(t===undefined&&(t=5e3),this._addToQueue(function(r){var u=!1,f=function(n,t){t===clippy.Animator.States.EXITED&&(u=!0,i&&i(),r())};t&&window.setTimeout($.proxy(function(){u||this._animator.exitAnimation()},this),t);this._playInternal(n,f)},this),!0):!1},show:function(n){if(this._hidden=!1,n){this._el.show();this.resume();this._onQueueEmpty();return}if(this._el.css("top")==="auto"||!1){var t=$(window).width()*.8,i=($(window).height()+$(document).scrollTop())*.8;this._el.css({top:i,left:t})}return this.resume(),this.play("Show")},speak:function(n,t){this._addToQueue(function(i){this._balloon.speak(i,n,t)},this)},closeBalloon:function(){this._balloon.hide()},delay:function(n){n=n||250;this._addToQueue(function(t){this._onQueueEmpty();window.setTimeout(t,n)})},stopCurrent:function(){this._animator.exitAnimation();this._balloon.close()},stop:function(){this._queue.clear();this._animator.exitAnimation();this._balloon.hide()},hasAnimation:function(n){return this._animator.hasAnimation(n)},animations:function(){return this._animator.animations()},animate:function(){var n=this.animations(),t=n[Math.floor(Math.random()*n.length)];return t.indexOf("Idle")===0?this.animate():this.play(t)},_getDirection:function(n,t){var r=this._el.offset(),u=this._el.height(),f=this._el.width(),e=r.left+f/2,o=r.top+u/2,s=o-t,h=e-n,i=Math.round(180*Math.atan2(s,h)/Math.PI);return-45<=i&&i<45?"Right":45<=i&&i<135?"Up":135<=i&&i<=180||-180<=i&&i<-135?"Left":-135<=i&&i<-45?"Down":"Top"},_onQueueEmpty:function(){if(!this._hidden&&!this._isIdleAnimation()){var n=this._getIdleAnimation();this._idleDfd=$.Deferred();this._animator.showAnimation(n,$.proxy(this._onIdleComplete,this))}},_onIdleComplete:function(n,t){t===clippy.Animator.States.EXITED&&this._idleDfd.resolve()},_isIdleAnimation:function(){var n=this._animator.currentAnimationName;return n&&n.indexOf("Idle")===0},_getIdleAnimation:function(){for(var i,u,r=this.animations(),n=[],t=0;t<r.length;t++)i=r[t],i.indexOf("Idle")===0&&n.push(i);return u=Math.floor(Math.random()*n.length),n[u]},_setupEvents:function(){$(window).on("resize",$.proxy(this.reposition,this));this._el.on("mousedown",$.proxy(this._onMouseDown,this));this._el.on("dblclick",$.proxy(this._onDoubleClick,this))},_onDoubleClick:function(){this.play("ClickedOn")||this.animate()},reposition:function(){if(this._el.is(":visible")){var r=this._el.offset(),u=this._el.outerHeight(),f=this._el.outerWidth(),e=$(window).width(),o=$(window).height(),s=$(window).scrollTop(),h=$(window).scrollLeft(),t=r.top-s,i=r.left-h,n=5;t-n<0?t=n:t+u+n>o&&(t=o-u-n);i-n<0?i=n:i+f+n>e&&(i=e-f-n);this._el.css({left:i,top:t});this._balloon.reposition()}},_onMouseDown:function(n){n.preventDefault();this._startDrag(n)},_startDrag:function(n){this.pause();this._balloon.hide(!0);this._offset=this._calculateClickOffset(n);this._moveHandle=$.proxy(this._dragMove,this);this._upHandle=$.proxy(this._finishDrag,this);$(window).on("mousemove",this._moveHandle);$(window).on("mouseup",this._upHandle);this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_calculateClickOffset:function(n){var i=n.pageX,r=n.pageY,t=this._el.offset();return{top:r-t.top,left:i-t.left}},_updateLocation:function(){this._el.css({top:this._targetY,left:this._taregtX});this._dragUpdateLoop=window.setTimeout($.proxy(this._updateLocation,this),10)},_dragMove:function(n){n.preventDefault();var t=n.clientX-this._offset.left,i=n.clientY-this._offset.top;this._taregtX=t;this._targetY=i},_finishDrag:function(){window.clearTimeout(this._dragUpdateLoop);$(window).off("mousemove",this._moveHandle);$(window).off("mouseup",this._upHandle);this._balloon.show();this.reposition();this.resume()},_addToQueue:function(n,t){t&&(n=$.proxy(n,t));this._queue.queue(n)},pause:function(){this._animator.pause();this._balloon.pause()},resume:function(){this._animator.resume();this._balloon.resume()}};clippy.Animator=function(n,t,i,r){var f,e,u;for(this._el=n,this._data=i,this._path=t,this._currentFrameIndex=0,this._currentFrame=undefined,this._exiting=!1,this._currentAnimation=undefined,this._endCallback=undefined,this._started=!1,this._sounds={},this.currentAnimationName=undefined,this.preloadSounds(r),this._overlays=[this._el],f=this._el,this._setupElement(this._el),e=1;e<this._data.overlayCount;e++)u=this._setupElement($("<div><\/div>")),f.append(u),this._overlays.push(u),f=u};clippy.Animator.prototype={_setupElement:function(n){var t=this._data.framesize;return n.css("display","none"),n.css({width:t[0],height:t[1]}),n.css("background","url('"+this._path+"/map.png') no-repeat"),n},animations:function(){var n=[],t=this._data.animations;for(var i in t)n.push(i);return n},preloadSounds:function(n){for(var i,r,t=0;t<this._data.sounds.length;t++)(i=this._data.sounds[t],r=n[i],r)&&(this._sounds[i]=new Audio(r))},hasAnimation:function(n){return!!this._data.animations[n]},exitAnimation:function(){this._exiting=!0},showAnimation:function(n,t){return(this._exiting=!1,!this.hasAnimation(n))?!1:(this._currentAnimation=this._data.animations[n],this.currentAnimationName=n,this._started||(this._step(),this._started=!0),this._currentFrameIndex=0,this._currentFrame=undefined,this._endCallback=t,!0)},_draw:function(){var t=[],n,i,r;for(this._currentFrame&&(t=this._currentFrame.images||[]),n=0;n<this._overlays.length;n++)n<t.length?(i=t[n],r=-i[0]+"px "+-i[1]+"px",this._overlays[n].css({"background-position":r,display:"block"})):this._overlays[n].css("display","none")},_getNextAnimationFrame:function(){var r,n,u,t,i;if(!this._currentAnimation)return undefined;if(!this._currentFrame)return 0;if(r=this._currentFrame,n=this._currentFrame.branching,this._exiting&&r.exitBranch!==undefined)return r.exitBranch;if(n)for(u=Math.random()*100,t=0;t<n.branches.length;t++){if(i=n.branches[t],u<=i.weight)return i.frameIndex;u-=i.weight}return this._currentFrameIndex+1},_playSound:function(){var t=this._currentFrame.sound,n;t&&(n=this._sounds[t],n&&n.play())},_atLastFrame:function(){return this._currentFrameIndex>=this._currentAnimation.frames.length-1},_step:function(){if(this._currentAnimation){var n=Math.min(this._getNextAnimationFrame(),this._currentAnimation.frames.length-1),t=!this._currentFrame||this._currentFrameIndex!==n;this._currentFrameIndex=n;this._atLastFrame()&&this._currentAnimation.useExitBranching||(this._currentFrame=this._currentAnimation.frames[this._currentFrameIndex]);this._draw();this._playSound();this._loop=window.setTimeout($.proxy(this._step,this),this._currentFrame.duration);this._endCallback&&t&&this._atLastFrame()&&(this._currentAnimation.useExitBranching&&!this._exiting?this._endCallback(this.currentAnimationName,clippy.Animator.States.WAITING):this._endCallback(this.currentAnimationName,clippy.Animator.States.EXITED))}},pause:function(){window.clearTimeout(this._loop)},resume:function(){this._step()}};clippy.Animator.States={WAITING:1,EXITED:0};clippy.Balloon=function(n){this._targetEl=n;this._hidden=!0;this._setup()};clippy.Balloon.prototype={WORD_SPEAK_TIME:320,CLOSE_BALLOON_DELAY:2e3,_setup:function(){this._balloon=$('<div class="clippy-balloon"><div class="clippy-tip"><\/div><div class="clippy-content"><\/div><\/div> ').hide();this._content=this._balloon.find(".clippy-content");$(document.body).append(this._balloon)},reposition:function(){for(var i,t=["top-left","top-right","bottom-left","bottom-right"],n=0;n<t.length;n++)if(i=t[n],this._position(i),!this._isOut())break},_BALLOON_MARGIN:15,_position:function(n){var t=this._targetEl.offset(),u=this._targetEl.height(),f=this._targetEl.width(),e=this._balloon.outerHeight(),o=this._balloon.outerWidth(),i,r;this._balloon.removeClass("clippy-top-left");this._balloon.removeClass("clippy-top-right");this._balloon.removeClass("clippy-bottom-right");this._balloon.removeClass("clippy-bottom-left");switch(n){case"top-left":i=t.left+f-o;r=t.top-e-this._BALLOON_MARGIN;break;case"top-right":i=t.left;r=t.top-e-this._BALLOON_MARGIN;break;case"bottom-right":i=t.left;r=t.top+u+this._BALLOON_MARGIN;break;case"bottom-left":i=t.left+f-o;r=t.top+u+this._BALLOON_MARGIN}this._balloon.css({top:r,left:i});this._balloon.addClass("clippy-"+n)},_isOut:function(){var t=this._balloon.offset(),u=this._balloon.outerHeight(),f=this._balloon.outerWidth(),e=$(window).width(),o=$(window).height(),s=$(document).scrollTop(),h=$(document).scrollLeft(),i=t.top-s,r=t.left-h,n=5;return i-n<0||r-n<0?!0:i+u+n>o||r+f+n>e?!0:!1},speak:function(n,t,i){this._hidden=!1;this.show();var r=this._content;r.height("auto");r.width("auto");r.text(t);r.height(r.height());r.width(r.width());r.text("");this.reposition();this._complete=n;this._sayWords(t,i,n)},show:function(){this._hidden||this._balloon.show()},hide:function(n){if(n){this._balloon.hide();return}this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)},_finishHideBalloon:function(){this._active||(this._balloon.hide(),this._hidden=!0,this._hiding=null)},_sayWords:function(n,t,i){this._active=!0;this._hold=t;var u=n.split(/[^\S-]/),f=this.WORD_SPEAK_TIME,e=this._content,r=1;this._addWord=$.proxy(function(){this._active&&(r>u.length?(this._active=!1,this._hold||(i(),this.hide())):(e.text(u.slice(0,r).join(" ")),r++,this._loop=window.setTimeout($.proxy(this._addWord,this),f)))},this);this._addWord()},close:function(){this._active?this._hold=!1:this._hold&&this._complete()},pause:function(){window.clearTimeout(this._loop);this._hiding&&(window.clearTimeout(this._hiding),this._hiding=null)},resume:function(){this._addWord&&this._addWord();this._hiding=window.setTimeout($.proxy(this._finishHideBalloon,this),this.CLOSE_BALLOON_DELAY)}};clippy.BASE_PATH="//s3.amazonaws.com/clippy.js/Agents/";clippy.load=function(n,t,i){var r=clippy.BASE_PATH+n,h=clippy.load._loadMap(r),u=clippy.load._loadAgent(n,r),f=clippy.load._loadSounds(n,r),e,o,s;u.done(function(n){e=n});f.done(function(n){o=n});s=function(){var n=new clippy.Agent(r,e,o);t(n)};$.when(h,u,f).done(s).fail(i)};clippy.load._maps={};clippy.load._loadMap=function(n){var t=clippy.load._maps[n],r,i;return t?t:(t=clippy.load._maps[n]=$.Deferred(),r=n+"/map.png",i=new Image,i.onload=t.resolve,i.onerror=t.reject,i.setAttribute("src",r),t.promise())};clippy.load._sounds={};clippy.load._loadSounds=function(n,t){var i=clippy.load._sounds[n],f;if(i)return i;i=clippy.load._sounds[n]=$.Deferred();var r=document.createElement("audio"),u=!!r.canPlayType&&""!==r.canPlayType("audio/mpeg"),e=!!r.canPlayType&&""!==r.canPlayType('audio/ogg; codecs="vorbis"');return u||e?(f=t+(u?"/sounds-mp3.js":"/sounds-ogg.js"),clippy.load._loadScript(f)):i.resolve({}),i.promise()};clippy.load._data={};clippy.load._loadAgent=function(n,t){var i=clippy.load._data[n],r;return i?i:(i=clippy.load._getAgentDfd(n),r=t+"/agent.js",clippy.load._loadScript(r),i.promise())};clippy.load._loadScript=function(n){var t=document.createElement("script");t.setAttribute("src",n);t.setAttribute("async","async");t.setAttribute("type","text/javascript");document.head.appendChild(t)};clippy.load._getAgentDfd=function(n){var t=clippy.load._data[n];return t||(t=clippy.load._data[n]=$.Deferred()),t};clippy.ready=function(n,t){var i=clippy.load._getAgentDfd(n);i.resolve(t)};clippy.soundsReady=function(n,t){var i=clippy.load._sounds[n];i||(i=clippy.load._sounds[n]=$.Deferred());i.resolve(t)};clippy.Queue=function(n){this._queue=[];this._onEmptyCallback=n};clippy.Queue.prototype={queue:function(n){this._queue.push(n);this._queue.length!==1||this._active||this._progressQueue()},_progressQueue:function(){var n,t;if(!this._queue.length){this._onEmptyCallback();return}n=this._queue.shift();this._active=!0;t=$.proxy(this.next,this);n(t)},clear:function(){this._queue=[]},next:function(){this._active=!1;this._progressQueue()}};